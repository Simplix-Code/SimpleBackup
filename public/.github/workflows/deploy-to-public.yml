name: Deploy to public repo

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[deploy]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4

      - name: Clone PUBLIC repo (Simplix-Code/SimpleBackup)
        env:
          PUBLIC_REPO_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          git clone \
            https://x-access-token:${PUBLIC_REPO_TOKEN}@github.com/Simplix-Code/SimpleBackup.git \
            public

      - name: Sync private -> public (1:1, aber Build-Action behalten)
        run: |
          set +e
          rsync -av --delete \
            --exclude ".git" \
            --exclude ".github/workflows/build-deb.yml" \
            ./ public/
          rsync_rc=$?
          set -e
          if [ $rsync_rc -ne 0 ] && [ $rsync_rc -ne 24 ]; then
            echo "rsync failed with exit code $rsync_rc"
            exit $rsync_rc
          fi

      - name: Configure git in public repo
        working-directory: public
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit and push to public
        working-directory: public
        run: |
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "deploy from private repo ($(date -u +%Y-%m-%dT%H:%M:%SZ))"
            git push origin main
          else
            echo "No changes to push."
          fi
